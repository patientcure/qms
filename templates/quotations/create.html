{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Create Quotation{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Left Column: Form -->
  <div>
    <form id="q-form" method="post" class="space-y-4"
      action="{% if object %}{% url 'quotations:update' object.pk %}{% else %}{% url 'quotations:admin_create_quotation' %}{% endif %}">
      {% csrf_token %}

      <!-- Quotation Section -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="font-semibold text-lg mb-4">Quotation Details</h2>

        <!-- Customer Row with Add Button -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
          <div class="flex gap-2">
            {{ form.customer|add_class:"flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none
            focus:ring-2 focus:ring-blue-500" }}
            <button type="button" onclick="openModal('customer-modal')"
              class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              <i class="fas fa-plus mr-1"></i> New
            </button>
          </div>
          {% if form.customer.errors %}
          <div class="mt-1 text-sm text-red-600">{{ form.customer.errors }}</div>
          {% endif %}
        </div>

        <!-- Details Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Assigned To</label>
            {{ form.assigned_to|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Follow-up Date</label>
            {{ form.follow_up_date|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
            {{ form.currency|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Terms</label>
            {{ form.terms|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Email Template</label>
            {{ form.email_template|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
          </div>
        </div>
      </div>

      <!-- Items Section -->
      <div class="bg-white p-6 rounded-xl shadow">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-lg">Items</h3>
          <button type="button" id="add-item"
            class="px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 transition-colors">
            <i class="fas fa-plus mr-1"></i> Add Item
          </button>
        </div>

        {{ formset.management_form }}
        <div id="items" class="space-y-3">
          {% for form in formset %}
          <div class="item-row grid grid-cols-12 gap-2 p-3 border border-gray-200 rounded-md">
            <div class="col-span-5">
              <div class="flex gap-2">
                {{ form.product|add_class:"flex-1 border border-gray-300 rounded-md px-2 py-1 text-sm" }}
                <button type="button" onclick="openModal('product-modal')"
                  class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs hover:bg-blue-700 transition-colors">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="col-span-4">
              {{ form.description|add_class:"w-full border border-gray-300 rounded-md px-2 py-1
              text-sm"|attr:"placeholder:Description" }}
            </div>
            <div class="col-span-1">
              {{ form.quantity|add_class:"w-full border border-gray-300 rounded-md px-2 py-1
              text-sm"|attr:"placeholder:Qty" }}
            </div>
            <div class="col-span-1">
              {{ form.unit_price|add_class:"w-full border border-gray-300 rounded-md px-2 py-1
              text-sm"|attr:"placeholder:Price" }}
            </div>
            <div class="col-span-1">
              {{ form.tax_rate|add_class:"w-full border border-gray-300 rounded-md px-2 py-1
              text-sm"|attr:"placeholder:Tax %" }}
            </div>
            {% if form.DELETE %}
            <div class="col-span-12 flex justify-end">
              <label class="flex items-center text-sm text-red-600">
                {{ form.DELETE }} Delete this item
              </label>
            </div>
            {% endif %}
            {{ form.id }}
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Totals Section -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="font-semibold text-lg mb-3">Summary</h3>
        <div class="grid grid-cols-3 gap-4">
          <div class="bg-gray-50 p-3 rounded-md">
            <div class="text-sm text-gray-500">Subtotal</div>
            <div id="subtotal" class="text-xl font-semibold">0.00</div>
          </div>
          <div class="bg-gray-50 p-3 rounded-md">
            <div class="text-sm text-gray-500">Tax</div>
            <div id="tax-total" class="text-xl font-semibold">0.00</div>
          </div>
          <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
            <div class="text-sm text-blue-600">Total</div>
            <div id="grand-total" class="text-2xl font-bold text-blue-800">0.00</div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex flex-wrap gap-3">
        <button type="submit" name="save"
          class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          <i class="fas fa-save mr-2"></i> Save
        </button>
        {% if object %}
        <button type="button" id="btn-send"
          class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
          <i class="fas fa-paper-plane mr-2"></i> Send Quotation
        </button>
        <a href="{% url 'quotations:list' %}"
          class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
          Cancel
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Right Column: Preview -->
  <div class="sticky top-4 h-fit">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
      <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center">
        <h3 class="font-semibold">Live Preview</h3>
        <div class="text-sm bg-gray-700 px-2 py-1 rounded">{% if object %}{{ object.quotation_number }}{% else
          %}PREVIEW{% endif %}</div>
      </div>
      <iframe id="preview" class="w-full h-[calc(100vh-150px)] border-0"
        srcdoc="<div class='flex items-center justify-center h-full text-gray-400'><div class='text-center'><i class='fas fa-file-invoice text-4xl mb-2'></i><p>Preview will appear here</p></div></div>"></iframe>
    </div>
  </div>
</div>

<!-- Customer Modal -->
<div id="customer-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-semibold">New Customer</h3>
      <button onclick="closeModal('customer-modal')" class="text-gray-400 hover:text-gray-500">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="customer-form" class="p-4 space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name*</label>
        <input name="name"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
        <input name="company_name" class="w-full border border-gray-300 rounded-md px-3 py-2">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
          <input name="email" type="email" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
          <input name="phone" class="w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
        <textarea name="address" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">GST Number</label>
        <input name="gst_number" class="w-full border border-gray-300 rounded-md px-3 py-2">
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" onclick="closeModal('customer-modal')"
          class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          Save Customer
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Product Modal -->
<div id="product-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-semibold">New Product</h3>
      <button onclick="closeModal('product-modal')" class="text-gray-400 hover:text-gray-500">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="product-form" class="p-4 space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name*</label>
        <input name="name" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">SKU</label>
        <input name="sku" class="w-full border border-gray-300 rounded-md px-3 py-2">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price*</label>
          <input name="unit_price" type="number" step="0.01" min="0"
            class="w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tax Rate (%)</label>
          <input name="tax_rate" type="number" step="0.01" min="0" max="100"
            class="w-full border border-gray-300 rounded-md px-3 py-2" value="0">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea name="description" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
      </div>
      <div class="flex items-center">
        <input name="active" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
        <label class="ml-2 block text-sm text-gray-700">Active</label>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" onclick="closeModal('product-modal')"
          class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          Save Product
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Utility Functions
  function showToast(message, type = 'success', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg text-white flex items-center 
    ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} animate-fade-in`;
    toast.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
    <span>${message}</span>
  `;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-y-2');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // Live Preview System
  let previewDebounce;
  function updatePreview() {
    clearTimeout(previewDebounce);
    const preview = document.getElementById('preview');
    preview.srcdoc = `
    <div class="flex items-center justify-center h-full bg-gray-50">
      <div class="text-center text-gray-400">
        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
        <p>Generating preview...</p>
      </div>
    </div>
  `;

    previewDebounce = setTimeout(() => {
      const formData = new FormData(document.getElementById('q-form'));
      fetch("{% url 'quotations:ajax_live_preview' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
      })
        .then(response => {
          if (!response.ok) throw new Error('Server error');
          return response.json();
        })
        .then(data => {
          if (data.html) {
            preview.srcdoc = data.html;
          } else {
            preview.srcdoc = `
          <div class="p-4 text-red-500">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            ${data.error || 'Preview generation failed'}
          </div>
        `;
          }
        })
        .catch(error => {
          preview.srcdoc = `
        <div class="p-4 text-red-500">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          ${error.message}
        </div>
      `;
        });
    }, 500);
  }

  // Real-Time Calculations
  function calculateTotals() {
    let subtotal = 0, taxTotal = 0;

    document.querySelectorAll('.item-row').forEach(row => {
      const qty = parseFloat(row.querySelector('[name*="-quantity"]').value) || 0;
      const price = parseFloat(row.querySelector('[name*="-unit_price"]').value) || 0;
      const taxRate = parseFloat(row.querySelector('[name*="-tax_rate"]').value) || 0;

      const rowTotal = qty * price;
      subtotal += rowTotal;
      taxTotal += rowTotal * (taxRate / 100);
    });

    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('tax-total').textContent = taxTotal.toFixed(2);
    document.getElementById('grand-total').textContent = (subtotal + taxTotal).toFixed(2);
  }

  // Form Management
  function addItemRow() {
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');
    const formIdx = parseInt(totalForms.value);
    const newRow = document.querySelector('.item-row').cloneNode(true);

    // Update all inputs in the new row
    newRow.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.name) {
        el.name = el.name.replace(/form-\d+-/, `form-${formIdx}-`);
        el.value = '';
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        if (el.id) el.id = el.id.replace(/_\d+_/, `_${formIdx}_`);
      }
    });

    // Reset DELETE checkbox if present
    const deleteCheckbox = newRow.querySelector('[name$="-DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = false;
    }

    document.getElementById('items').appendChild(newRow);
    totalForms.value = formIdx + 1;
    calculateTotals();
  }

  // Customer Form Submission
  document.getElementById('customer-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

    try {
      const formData = new FormData(form);
      const response = await fetch("{% url 'quotations:ajax_customer_new' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      });

      const data = await response.json();
      if (response.ok) {
        // Update all customer selects
        document.querySelectorAll('select[name="customer"]').forEach(select => {
          const option = new Option(data.name, data.id);
          select.add(option);
          select.value = data.id;
        });
        closeModal('customer-modal');
        showToast('Customer added successfully');
        updatePreview();
      } else {
        showToast(data.errors || 'Error saving customer', 'error');
      }
    } catch (error) {
      showToast('Network error occurred', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });

  // Product Form Submission (similar to customer form)
  document.getElementById('product-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

    try {
      const formData = new FormData(form);
      const response = await fetch("{% url 'quotations:ajax_product_new' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      });

      const data = await response.json();
      if (response.ok) {
        // Update all product selects
        document.querySelectorAll('select[name*="-product"]').forEach(select => {
          const option = new Option(data.name, data.id);
          select.add(option);
          select.value = data.id;
        });
        closeModal('product-modal');
        showToast('Product added successfully');
      } else {
        showToast(data.errors || 'Error saving product', 'error');
      }
    } catch (error) {
      showToast('Network error occurred', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });

  // Main Form Submission
  document.getElementById('q-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      });

      if (response.ok) {
        const data = await response.json();
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          showToast('Quotation saved successfully');
          updatePreview();
        }
      } else {
        const error = await response.json();
        showToast(error.message || 'Error saving quotation', 'error');
      }
    } catch (error) {
      showToast('Network error occurred', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });

  // Send Quotation Handler
  // Send Quotation Handler
  // Send Quotation Handler
  // Send Quotation Handler
  const sendBtn = document.getElementById('btn-send');
  if (sendBtn) {

  }

  // Initialize Event Listeners
  document.addEventListener('DOMContentLoaded', function () {
    // Add item button
    document.getElementById('add-item').addEventListener('click', addItemRow);

    // Calculate totals when item values change
    document.getElementById('items').addEventListener('input', function (e) {
      if (e.target.name && (e.target.name.includes('quantity') ||
        e.target.name.includes('unit_price') ||
        e.target.name.includes('tax_rate'))) {
        calculateTotals();
      }
    });

    // Update preview when form changes
    document.getElementById('q-form').addEventListener('input', updatePreview);

    // Initialize calculations and preview if form has data
    calculateTotals();
    if (document.querySelector('[name="customer"]').value) {
      updatePreview();
    }
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
  }
</style>
{% endblock %}