{% load static %}
{% load widget_tweaks %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Quotation{% endblock %}

{% block extra_head %}
<style>
* { box-sizing: border-box; }

.quotation-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
}

.main-grid {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 30px;
}

@media (max-width: 1024px) {
  .main-grid { grid-template-columns: 1fr; }
}

.form-column {
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
}

.preview-column {
  position: sticky;
  top: 20px;
  height: fit-content;
}

.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  border-bottom: 2px solid #f1f5f9;
  padding-bottom: 20px;
}

.header-title {
  font-size: 28px;
  font-weight: bold;
  color: #1e293b;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn-primary, .btn-secondary, .btn-cancel, .btn-success, .btn-preview {
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  transition: background-color 0.2s;
}

.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover { background: #2563eb; }
.btn-secondary { background: #64748b; color: white; padding: 10px 20px; }
.btn-secondary:hover { background: #475569; }
.btn-cancel { background: #ef4444; color: white; padding: 10px 20px; }
.btn-cancel:hover { background: #dc2626; }
.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }
.btn-preview { background: #6366f1; color: white; }
.btn-preview:hover { background: #4f46e5; }

.btn-icon {
  background: #f8fafc;
  color: #64748b;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
}

.btn-icon-danger {
  background: #fef2f2;
  color: #ef4444;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #fecaca;
  cursor: pointer;
}

.btn-input-action {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-left: none;
  padding: 8px 12px;
  border-radius: 0 6px 6px 0;
  cursor: pointer;
  color: #64748b;
}

.form-sections {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-section {
  background: #f8fafc;
  padding: 24px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-header h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
  margin: 0;
}

.grid { display: grid; }
.grid-cols-1 { grid-template-columns: 1fr; }
.grid-cols-2 { grid-template-columns: 1fr 1fr; }
.grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
.gap-4 { gap: 16px; }
.space-y-4 > * + * { margin-top: 16px; }
.flex { display: flex; }
.space-x-2 > * + * { margin-left: 8px; }

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-weight: 500;
  color: #374151;
  font-size: 14px;
}

.form-control {
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  background: white;
}

.form-control:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.input-group {
  display: flex;
}

.input-group .form-control {
  border-radius: 6px 0 0 6px;
  border-right: none;
}

.customer-details {
  background: white;
  padding: 16px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  margin-top: 12px;
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.detail-label {
  font-weight: 500;
  color: #6b7280;
  margin-right: 8px;
}

.items-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.item-row {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
}

.item-grid {
  display: grid;
  grid-template-columns: 2fr 3fr 1fr 1.5fr 1fr 60px;
  gap: 12px;
  align-items: end;
}

.item-product, .item-description, .item-quantity, .item-price, .item-tax, .item-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.preview-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
  overflow: hidden;
}

.preview-header {
  background: #f8fafc;
  padding: 16px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.preview-frame {
  width: 100%;
  height: 600px;
  border: none;
  background: white;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 24px 0;
  border-top: 1px solid #e5e7eb;
  margin-top: 24px;
}

.totals-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.total-item {
  background: #f9fafb;
  padding: 12px;
  border-radius: 6px;
  text-align: center;
}

.total-item.total-final {
  background: #dbeafe;
  border: 1px solid #93c5fd;
}

.total-label {
  font-size: 12px;
  color: #6b7280;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.total-amount {
  font-size: 18px;
  font-weight: 600;
  color: #1e293b;
}

.total-final .total-label { color: #1e40af; }
.total-final .total-amount { color: #1e40af; }

.error-message {
  color: #ef4444;
  font-size: 12px;
  margin-top: 4px;
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  min-width: 300px;
  color: white;
}

.toast.toast-success { background: #10b981; }
.toast.toast-error { background: #ef4444; }
.toast.toast-info { background: #3b82f6; }

.loading {
  opacity: 0.7;
  pointer-events: none;
}

@media (max-width: 768px) {
  .main-grid { grid-template-columns: 1fr; }
  .item-grid { grid-template-columns: 1fr; gap: 12px; }
  .detail-grid { grid-template-columns: 1fr; }
  .totals-grid { grid-template-columns: 1fr; }
  .form-actions { justify-content: stretch; }
  .form-actions button { flex: 1; }
}
</style>

<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Alpine.js for reactivity -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}

{% block content %}
<div x-data="quotationApp()" x-init="init()" class="quotation-container">
  <!-- Main Layout -->
  <div class="main-grid">
    <!-- Left Column - Form -->
    <div class="form-column">
      <!-- Header -->
      <div class="header-section">
        <h1 class="header-title">
          {% if object %}Edit{% else %}Create{% endif %} Quotation
        </h1>
        <div class="header-actions">
          <button @click="saveDraft()" class="btn-secondary" :disabled="state.loading">
            <i class="fas fa-save"></i> Save Draft
          </button>
          <a href="{% url 'quotations:admin_dashboard' %}" class="btn-cancel">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </div>

      <!-- Form -->
      <form id="quotation-form" method="post" enctype="multipart/form-data" 
            class="form-sections" :class="{'loading': state.loading}">
        {% csrf_token %}
        
        <!-- Customer Section -->
        <div class="form-section">
          <div class="section-header">
            <h2>Customer Information</h2>
            <button type="button" @click="openModal('customer')" class="btn-icon">
              <i class="fas fa-plus"></i> New Customer
            </button>
          </div>
          
          <div class="grid grid-cols-1 gap-4">
            <div class="form-group">
              <label for="id_customer">Customer *</label>
              <div class="input-group">
                {{ form.customer|add_class:"form-control" }}
                <button type="button" @click="openCustomerSearch()" class="btn-input-action">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              {% if form.customer.errors %}
              <div class="error-message">{{ form.customer.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Customer Details Display -->
            <div class="customer-details" x-show="state.customerDetails" x-transition>
              <div class="detail-grid">
                <div>
                  <span class="detail-label">Company:</span>
                  <span x-text="state.customerDetails?.company_name || 'N/A'"></span>
                </div>
                <div>
                  <span class="detail-label">Email:</span>
                  <span x-text="state.customerDetails?.email || 'N/A'"></span>
                </div>
                <div>
                  <span class="detail-label">Phone:</span>
                  <span x-text="state.customerDetails?.phone || 'N/A'"></span>
                </div>
                <div>
                  <span class="detail-label">Address:</span>
                  <span x-text="state.customerDetails?.address || 'N/A'"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quotation Details -->
        <div class="form-section">
          <div class="section-header">
            <h2>Quotation Details</h2>
          </div>

          <div class="grid grid-cols-1 gap-4">
            <div class="grid grid-cols-2 gap-4">
              <!-- Left Column -->
              <div class="space-y-4">
                <div class="form-group">
                  <label for="id_quotation_number">Quotation Number</label>
                  {{ form.quotation_number|add_class:"form-control" }}
                  {% if form.quotation_number.errors %}
                  <div class="error-message">{{ form.quotation_number.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="id_assigned_to">Assigned To</label>
                  {{ form.assigned_to|add_class:"form-control" }}
                  {% if form.assigned_to.errors %}
                  <div class="error-message">{{ form.assigned_to.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="id_valid_until">Valid Until</label>
                  {{ form.valid_until|add_class:"form-control" }}
                  {% if form.valid_until.errors %}
                  <div class="error-message">{{ form.valid_until.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Right Column -->
              <div class="space-y-4">
                <div class="form-group">
                  <label for="id_currency">Currency</label>
                  {{ form.currency|add_class:"form-control" }}
                  {% if form.currency.errors %}
                  <div class="error-message">{{ form.currency.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="id_terms">Terms & Conditions</label>
                  <div class="input-group">
                    {{ form.terms|add_class:"form-control" }}
                    <button type="button" @click="previewTerms()" class="btn-input-action">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                  {% if form.terms.errors %}
                  <div class="error-message">{{ form.terms.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="id_email_template">Email Template</label>
                  {{ form.email_template|add_class:"form-control" }}
                  {% if form.email_template.errors %}
                  <div class="error-message">{{ form.email_template.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="form-section">
          <div class="section-header">
            <h2>Items</h2>
            <div class="flex space-x-2">
              <button type="button" @click="addBlankItem()" class="btn-icon">
                <i class="fas fa-plus"></i> Add Item
              </button>
              <button type="button" @click="openModal('product')" class="btn-icon">
                <i class="fas fa-search"></i> Find Product
              </button>
            </div>
          </div>

          {{ formset.management_form }}
          <div id="items-container" class="items-container">
            {% for form in formset %}
            <div class="item-row" data-form-index="{{ forloop.counter0 }}">
              <div class="item-grid">
                <div class="item-product">
                  <label>Product</label>
                  <div class="input-group">
                    {{ form.product|add_class:"form-control" }}
                    <button type="button" @click="openProductSearch($event)" class="btn-input-action">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>

                <div class="item-description">
                  <label>Description</label>
                  {{ form.description|add_class:"form-control"|attr:"placeholder:Item description" }}
                </div>

                <div class="item-quantity">
                  <label>Qty</label>
                  {{ form.quantity|add_class:"form-control quantity-input"|attr:"placeholder:0"|attr:"step:0.01" }}
                </div>

                <div class="item-price">
                  <label>Price</label>
                  {{ form.unit_price|add_class:"form-control price-input"|attr:"placeholder:0.00"|attr:"step:0.01" }}
                </div>

                <div class="item-tax">
                  <label>Tax %</label>
                  {{ form.tax_rate|add_class:"form-control tax-input"|attr:"placeholder:0"|attr:"step:0.01" }}
                </div>

                <div class="item-actions">
                  <label>&nbsp;</label>
                  <button type="button" @click="removeItem($event)" class="btn-icon-danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              
              <!-- Hidden fields -->
              {{ form.id }}
              {% if form.DELETE %}
              {{ form.DELETE }}
              {% endif %}
            </div>
            {% empty %}
            <!-- Default empty item -->
            <div class="item-row" data-form-index="0">
              <div class="item-grid">
                <div class="item-product">
                  <label>Product</label>
                  <div class="input-group">
                    <select name="form-0-product" class="form-control" id="id_form-0-product">
                      <option value="">Select a product...</option>
                    </select>
                    <button type="button" @click="openProductSearch($event)" class="btn-input-action">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
                <div class="item-description">
                  <label>Description</label>
                  <input type="text" name="form-0-description" class="form-control" 
                         placeholder="Item description" id="id_form-0-description">
                </div>
                <div class="item-quantity">
                  <label>Qty</label>
                  <input type="number" name="form-0-quantity" class="form-control quantity-input" 
                         placeholder="1" step="0.01" id="id_form-0-quantity" value="1">
                </div>
                <div class="item-price">
                  <label>Price</label>
                  <input type="number" name="form-0-unit_price" class="form-control price-input" 
                         placeholder="0.00" step="0.01" id="id_form-0-unit_price">
                </div>
                <div class="item-tax">
                  <label>Tax %</label>
                  <input type="number" name="form-0-tax_rate" class="form-control tax-input" 
                         placeholder="0" step="0.01" id="id_form-0-tax_rate" value="0">
                </div>
                <div class="item-actions">
                  <label>&nbsp;</label>
                  <button type="button" @click="removeItem($event)" class="btn-icon-danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <input type="hidden" name="form-0-id" id="id_form-0-id">
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Totals Section -->
        <div class="form-section">
          <h3>Summary</h3>
          <div class="totals-grid">
            <div class="total-item">
              <div class="total-label">Subtotal</div>
              <div class="total-amount" x-text="formatCurrency(state.totals.subtotal)">0.00</div>
            </div>
            <div class="total-item">
              <div class="total-label">Tax</div>
              <div class="total-amount" x-text="formatCurrency(state.totals.tax)">0.00</div>
            </div>
            <div class="total-item total-final">
              <div class="total-label">Total</div>
              <div class="total-amount" x-text="formatCurrency(state.totals.total)">0.00</div>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="form-section">
          <div class="section-header">
            <h2>Additional Information</h2>
          </div>
          <div class="form-group">
            <label for="id_notes">Notes</label>
            {{ form.notes|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Additional notes or comments" }}
            {% if form.notes.errors %}
            <div class="error-message">{{ form.notes.errors.0 }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" @click="previewQuotation()" class="btn-preview" :disabled="state.loading">
            <i class="fas fa-eye"></i> Preview
          </button>
          <button type="button" @click="saveQuotation()" class="btn-primary" :disabled="state.loading">
            <i class="fas fa-save"></i> Save Quotation
          </button>
          {% if object %}
          <button type="button" @click="sendQuotation()" class="btn-success" :disabled="state.loading">
            <i class="fas fa-paper-plane"></i> Send to Customer
          </button>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- Right Column - Preview -->
    <div class="preview-column">
      <div class="preview-container">
        <div class="preview-header">
          <h3>Live Preview</h3>
          <div class="preview-actions">
            <button @click="refreshPreview()" class="btn-icon" :disabled="state.previewLoading">
              <i class="fas fa-sync-alt" :class="{'fa-spin': state.previewLoading}"></i>
            </button>
            <button @click="downloadPdf()" class="btn-icon" :disabled="state.loading">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>
        <iframe id="preview-frame" class="preview-frame" x-ref="previewFrame"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
function quotationApp() {
  return {
    // Application State
    state: {
      loading: false,
      previewLoading: false,
      customerDetails: null,
      quotationNumber: '',
      totals: {
        subtotal: 0,
        tax: 0,
        total: 0
      }
    },

    // Initialize the application
    init() {
      console.log('Initializing quotation app...');
      this.setupEventListeners();
      this.loadCustomerDetails();
      this.calculateTotals();
      this.previewQuotation();
      this.ensureMinimumItems();
    },

    // Ensure at least one item row exists
    ensureMinimumItems() {
      const container = document.getElementById('items-container');
      if (!container.children.length) {
        this.addBlankItem();
      }
    },

    // Setup event listeners
    setupEventListeners() {
      // Customer select change
      const customerSelect = document.querySelector('[name="customer"]');
      if (customerSelect) {
        customerSelect.addEventListener('change', (e) => {
          this.loadCustomerDetails(e.target.value);
          this.debouncedPreview();
        });
      }

      // Items container event delegation
      const itemsContainer = document.getElementById('items-container');
      if (itemsContainer) {
        itemsContainer.addEventListener('input', (e) => {
          if (e.target.matches('.quantity-input, .price-input, .tax-input')) {
            this.calculateTotals();
            this.debouncedPreview();
          }
        });

        itemsContainer.addEventListener('change', (e) => {
          if (e.target.name && e.target.name.includes('product')) {
            this.loadProductDetails(e.target);
            this.debouncedPreview();
          }
        });
      }

      // Form inputs for preview updates
      const form = document.getElementById('quotation-form');
      if (form) {
        form.addEventListener('input', (e) => {
          if (e.target.matches('input, select, textarea')) {
            this.debouncedPreview();
          }
        });
        
        form.addEventListener('submit', (e) => {
          e.preventDefault();
        });
      }
    },

    // Debounced preview function
    debouncedPreview: (() => {
      let timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          this.previewQuotation();
        }, 800);
      };
    })(),

    // Load customer details
    async loadCustomerDetails(customerId = null) {
      if (!customerId) {
        const customerSelect = document.querySelector('[name="customer"]');
        customerId = customerSelect ? customerSelect.value : null;
      }
      
      if (!customerId) {
        this.state.customerDetails = null;
        return;
      }

      try {
        // Try the API endpoint, fallback to a simple approach if it doesn't exist
        const response = await fetch(`/api/customers/${customerId}/`).catch(() => null);
        if (response && response.ok) {
          this.state.customerDetails = await response.json();
        } else {
          // Fallback - extract customer name from select option
          const customerSelect = document.querySelector('[name="customer"]');
          const selectedOption = customerSelect.querySelector(`option[value="${customerId}"]`);
          if (selectedOption) {
            this.state.customerDetails = {
              name: selectedOption.textContent,
              company_name: 'N/A',
              email: 'N/A',
              phone: 'N/A',
              address: 'N/A'
            };
          }
        }
      } catch (error) {
        console.error('Error loading customer details:', error);
        this.state.customerDetails = null;
      }
    },

    // Load product details when product is selected
    async loadProductDetails(productSelect) {
      const productId = productSelect.value;
      if (!productId) return;

      try {
        const response = await fetch(`/ajax/products/${productId}/`).catch(() => null);
        if (response && response.ok) {
          const data = await response.json();
          const row = productSelect.closest('.item-row');
          
          const priceInput = row.querySelector('.price-input');
          const taxInput = row.querySelector('.tax-input');
          
          if (priceInput && data.unit_price) {
            priceInput.value = data.unit_price;
          }
          if (taxInput && data.tax_rate) {
            taxInput.value = data.tax_rate;
          }
          
          this.calculateTotals();
        }
      } catch (error) {
        console.error('Error loading product details:', error);
      }
    },

    // Calculate item totals
    calculateTotals() {
      this.state.totals = { subtotal: 0, tax: 0, total: 0 };

      document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.quantity-input')?.value) || 0;
        const price = parseFloat(row.querySelector('.price-input')?.value) || 0;
        const taxRate = parseFloat(row.querySelector('.tax-input')?.value) || 0;

        const rowSubtotal = quantity * price;
        const rowTax = rowSubtotal * (taxRate / 100);

        this.state.totals.subtotal += rowSubtotal;
        this.state.totals.tax += rowTax;
      });

      this.state.totals.total = this.state.totals.subtotal + this.state.totals.tax;
    },

    // Format currency for display
    formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount || 0);
    },

    // Add a new blank item
    addBlankItem() {
      const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
      if (!totalFormsInput) {
        console.error('TOTAL_FORMS input not found');
        return;
      }
      
      const formIdx = parseInt(totalFormsInput.value) || 0;
      const container = document.getElementById('items-container');
      
      const newRowHtml = `
        <div class="item-row" data-form-index="${formIdx}">
          <div class="item-grid">
            <div class="item-product">
              <label>Product</label>
              <div class="input-group">
                <select name="form-${formIdx}-product" class="form-control" id="id_form-${formIdx}-product">
                  <option value="">Select a product...</option>
                </select>
                <button type="button" onclick="this.closest('[x-data]').__x.$data.openProductSearch(event)" class="btn-input-action">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="item-description">
              <label>Description</label>
              <input type="text" name="form-${formIdx}-description" class="form-control" 
                     placeholder="Item description" id="id_form-${formIdx}-description">
            </div>
            <div class="item-quantity">
              <label>Qty</label>
              <input type="number" name="form-${formIdx}-quantity" class="form-control quantity-input" 
                     placeholder="1" step="0.01" id="id_form-${formIdx}-quantity" value="1">
            </div>
            <div class="item-price">
              <label>Price</label>
              <input type="number" name="form-${formIdx}-unit_price" class="form-control price-input" 
                     placeholder="0.00" step="0.01" id="id_form-${formIdx}-unit_price">
            </div>
            <div class="item-tax">
              <label>Tax %</label>
              <input type="number" name="form-${formIdx}-tax_rate" class="form-control tax-input" 
                     placeholder="0" step="0.01" id="id_form-${formIdx}-tax_rate" value="0">
            </div>
            <div class="item-actions">
              <label>&nbsp;</label>
              <button type="button" onclick="this.closest('[x-data]').__x.$data.removeItem(event)" class="btn-icon-danger">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <input type="hidden" name="form-${formIdx}-id" id="id_form-${formIdx}-id">
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', newRowHtml);
      totalFormsInput.value = formIdx + 1;
      
      this.calculateTotals();
      this.debouncedPreview();
    },

    // Remove an item
    removeItem(event) {
      const row = event.target.closest('.item-row');
      const deleteCheckbox = row.querySelector('[name$="-DELETE"]');
      
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        row.style.display = 'none';
      } else {
        row.remove();
      }
      
      this.calculateTotals();
      this.debouncedPreview();
    },

    // Preview the quotation
    async previewQuotation() {
      this.state.previewLoading = true;
      const previewFrame = this.$refs.previewFrame;
      
      previewFrame.srcdoc = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui;">
          <div style="text-align: center; color: #6366f1;">
            <div style="font-size: 24px; margin-bottom: 10px;">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Generating preview...</p>
          </div>
        </div>
      `;

      const form = document.getElementById('quotation-form');
      const formData = new FormData(form);
      
      try {
        const response = await fetch("{% url 'quotations:ajax_live_preview' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: formData
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.html) {
            previewFrame.srcdoc = data.html;
          } else {
            throw new Error(data.error || 'Preview generation failed');
          }
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Preview error:', error);
        previewFrame.srcdoc = `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui;">
            <div style="text-align: center; color: #ef4444;">
              <div style="font-size: 24px; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <p>Preview unavailable</p>
              <p style="font-size: 12px; color: #6b7280;">${error.message}</p>
            </div>
          </div>
        `;
      } finally {
        this.state.previewLoading = false;
      }
    },

    // Refresh preview
    refreshPreview() {
      this.previewQuotation();
    },

    // Save as draft
    async saveDraft() {
      await this.submitForm('draft');
    },

    // Save quotation
    async saveQuotation() {
      await this.submitForm('save');
    },

    // Submit form
    async submitForm(action) {
      this.state.loading = true;
      const form = document.getElementById('quotation-form');
      const formData = new FormData(form);
      
      formData.append('action', action);

      try {
        const response = await fetch(form.action || window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
        
        if (response.ok) {
          const contentType = response.headers.get('content-type');
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            
            if (data.success) {
              this.showToast('Quotation saved successfully!', 'success');
              if (data.redirect) {
                setTimeout(() => window.location.href = data.redirect, 1500);
              }
            } else {
              this.showFormErrors(data.errors || {});
              this.showToast('Please fix the errors below', 'error');
            }
          } else {
            this.showToast(`Quotation ${action === 'draft' ? 'draft ' : ''}saved successfully!`, 'success');
          }
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Submit error:', error);
        this.showToast('An error occurred while saving', 'error');
      } finally {
        this.state.loading = false;
      }
    },

    // Send quotation
    async sendQuotation() {
      const confirmed = await this.showConfirmModal(
        'Send Quotation',
        'Are you sure you want to send this quotation to the customer?'
      );
      
      if (!confirmed) return;
      
      this.state.loading = true;
      const form = document.getElementById('quotation-form');
      const formData = new FormData(form);
      
      try {
        const response = await fetch("{% url 'quotations:send_quotation' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          this.showToast('Quotation sent successfully!', 'success');
          if (data.redirect) {
            setTimeout(() => window.location.href = data.redirect, 1500);
          }
        } else {
          throw new Error(data.error || 'Failed to send quotation');
        }
      } catch (error) {
        console.error('Send error:', error);
        this.showToast(error.message, 'error');
      } finally {
        this.state.loading = false;
      }
    },

    // Download PDF
    async downloadPdf() {
      this.state.loading = true;
      const form = document.getElementById('quotation-form');
      const formData = new FormData(form);
      
      try {
        const response = await fetch("{% url 'quotations:generate_pdf' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Quotation-${new Date().toISOString().slice(0,10)}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          this.showToast('PDF downloaded successfully!', 'success');
        } else {
          throw new Error('Failed to generate PDF');
        }
      } catch (error) {
        console.error('PDF error:', error);
        this.showToast('PDF generation not available yet', 'info');
      } finally {
        this.state.loading = false;
      }
    },

    // Show form errors
    showFormErrors(errors) {
      document.querySelectorAll('.error-message').forEach(el => {
        if (!el.textContent.includes('This field is required')) {
          el.textContent = '';
        }
      });
      
      for (const field in errors) {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
          const errorElement = input.closest('.form-group')?.querySelector('.error-message');
          if (errorElement) {
            errorElement.textContent = Array.isArray(errors[field]) ? 
              errors[field].join(', ') : errors[field];
          }
        }
      }
    },

    // Show toast message
    showToast(message, type = 'success') {
      document.querySelectorAll('.toast').forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    },

    // Modal and search placeholders
    openModal(type) {
      this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} creation modal not implemented yet`, 'info');
    },

    openCustomerSearch() {
      this.showToast('Customer search modal not implemented yet', 'info');
    },

    openProductSearch(event) {
      this.showToast('Product search modal not implemented yet', 'info');
    },

    previewTerms() {
      const termsSelect = document.querySelector('[name="terms"]');
      const termsId = termsSelect ? termsSelect.value : null;
      if (termsId) {
        this.showToast('Terms preview modal not implemented yet', 'info');
      } else {
        this.showToast('Please select terms & conditions first', 'error');
      }
    },

    showConfirmModal(title, message) {
      return Promise.resolve(confirm(`${title}\n\n${message}`));
    }
  };
}
</script>
{% endblock %}